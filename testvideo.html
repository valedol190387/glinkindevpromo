<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTVIDEO - –ü–µ—á–µ–Ω—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="module.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Initialize Telegram WebApp and request fullscreen IMMEDIATELY
        // This is CRITICAL for Kinescope to detect fullscreen capability on Android
        (function() {
            console.log('üöÄ Initializing Telegram WebApp...');

            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                console.log('‚úÖ Telegram WebApp ready');

                tg.expand();
                console.log('‚úÖ Telegram WebApp expanded');

                // IMPORTANT: Request fullscreen BEFORE iframe is created
                // This makes Fullscreen API available to Kinescope player
                setTimeout(function() {
                    if (tg.requestFullscreen) {
                        console.log('üì± Requesting Telegram fullscreen...');
                        tg.requestFullscreen();
                    } else {
                        console.log('‚ö†Ô∏è Telegram requestFullscreen not available');
                    }
                }, 100);
            } else {
                console.log('‚ùå Telegram WebApp not found');
            }
        })();
    </script>
</head>
<body>
    <!-- –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω -->
    <div class="bg-gradient"></div>

    <!-- –•–µ–¥–µ—Ä -->
    <header class="header glass-effect">
        <button class="back-button" onclick="window.location.href='index.html'">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <h1 class="page-title">TESTVIDEO</h1>
        <div class="header-spacer"></div>
    </header>

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <div class="module-header glass-effect">
            <h2 class="module-name">TESTVIDEO - –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h2>
            <p class="module-project">–ú–æ–¥—É–ª—å ‚Ññ3: –ü–µ—á–µ–Ω—å</p>
        </div>

        <!-- Kinescope Video Player -->
        <div class="content-section glass-effect">
            <h3 class="section-title">üìπ –¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ</h3>
            <div class="video-container" id="videoContainer">
                <!-- Iframe –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </main>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <nav class="bottom-nav glass-effect">
        <button class="nav-item" data-page="index">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button class="nav-item" data-page="calendar">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span class="nav-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
        </button>
        <button class="nav-item" data-page="bonuses">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            <span class="nav-label">–ë–æ–Ω—É—Å—ã</span>
        </button>
        <button class="nav-item" data-page="products">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span class="nav-label">–ü—Ä–æ–¥—É–∫—Ç—ã</span>
        </button>
        <button class="nav-item" data-page="profile">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>

    <script>
        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Kinescope iframe –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ Telegram –ø–µ—Ä–µ—à—ë–ª –≤ fullscreen
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded');

            const videoContainer = document.getElementById('videoContainer');
            const kinescopeId = 'hNUqb8FXReY9pXWFtMCLEV';

            function createKinescopeIframe() {
                console.log('üé¨ Creating Kinescope iframe...');

                // –°–æ–∑–¥–∞–µ–º iframe –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
                const iframeHTML = `
                    <div class="kinescope-container">
                        <div style="position: relative; padding-top: 56.25%; width: 100%">
                            <iframe
                                src="https://kinescope.io/embed/${kinescopeId}"
                                allow="autoplay; fullscreen; picture-in-picture; encrypted-media; gyroscope; accelerometer; clipboard-write; screen-wake-lock;"
                                frameborder="0"
                                allowfullscreen
                                webkitallowfullscreen
                                mozallowfullscreen
                                style="position: absolute; width: 100%; height: 100%; top: 0; left: 0;">
                            </iframe>
                        </div>
                    </div>
                `;

                videoContainer.innerHTML = iframeHTML;
                console.log('‚úÖ Kinescope iframe created');
            }

            // Wait for Telegram to enter fullscreen, then create iframe
            // This ensures Kinescope player detects fullscreen capability
            if (window.Telegram && window.Telegram.WebApp) {
                console.log('‚è≥ Waiting 500ms for Telegram fullscreen to activate...');
                setTimeout(createKinescopeIframe, 500);
            } else {
                // Not in Telegram, create immediately
                createKinescopeIframe();
            }
        });

        // Kinescope Fullscreen Events Handler (based on colleague's working implementation)
        window.onmessage = (event) => {
            // Debug: –ª–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç iframe
            if (event.data && event.data.type) {
                console.log('üì© Received postMessage event:', event.data.type, event.data);
            }

            if(event.data.type && event.data.type === 'KINESCOPE_PLAYER_FULLSCREEN_CHANGE'){
                console.log('üéØ KINESCOPE_PLAYER_FULLSCREEN_CHANGE detected! Value:', event.data.value);
                const frames = document.getElementsByTagName('iframe');
                for (let i = 0; i < frames.length; i++) {
                    if (frames[i].contentWindow === event.source) {
                        if(event.data.value){
                            // –í—Ö–æ–¥–∏–º –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
                            console.log('Entering fullscreen mode');
                            window.oldFrameStyles = frames[i].style.cssText;
                            frames[i].style.cssText = `
                                background: #000;
                                border: none;
                                position: fixed;
                                z-index: 9999;
                                width: 100%;
                                height: 100%;
                                bottom: 0;
                                right: 0;
                                top: 0;
                                left: 0;
                            `;

                            // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –≤ –ª–∞–Ω–¥—à–∞—Ñ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–ª—è –≤–∏–¥–µ–æ
                            try {
                                console.log('Attempting to lock landscape orientation...');

                                // 1. Telegram API –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                                if (window.Telegram?.WebApp) {
                                    // –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ Telegram v8.0+
                                    if (window.Telegram.WebApp.toggleOrientationLock) {
                                        console.log('Using Telegram toggleOrientationLock');
                                        window.Telegram.WebApp.toggleOrientationLock(true);
                                    }

                                    // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ postEvent –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
                                    try {
                                        if (window.TelegramWebviewProxy?.postEvent) {
                                            console.log('Using TelegramWebviewProxy.postEvent for landscape');
                                            window.TelegramWebviewProxy.postEvent('web_app_toggle_orientation_lock', JSON.stringify({locked: true}));
                                        } else if (window.parent) {
                                            console.log('Using window.parent.postMessage for landscape');
                                            const data = JSON.stringify({
                                                eventType: 'web_app_toggle_orientation_lock',
                                                eventData: { locked: true }
                                            });
                                            window.parent.postMessage(data, 'https://web.telegram.org');
                                        }
                                    } catch (e) {
                                        console.log('Telegram API fallback failed:', e);
                                    }
                                }

                                // 2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Screen Orientation API
                                if (screen.orientation && screen.orientation.lock) {
                                    console.log('Using screen.orientation.lock');
                                    screen.orientation.lock('landscape-primary').catch(err => {
                                        console.log('Primary landscape failed, trying any landscape');
                                        screen.orientation.lock('landscape').catch(err2 => {
                                            console.log('All orientation locks failed:', err2);
                                        });
                                    });
                                }

                                // 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π CSS –ø–æ–≤–æ—Ä–æ—Ç –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
                                if (window.innerHeight > window.innerWidth) {
                                    console.log('Applying CSS rotation for portrait mode');
                                    frames[i].style.cssText += `
                                        transform: rotate(90deg) !important;
                                        transform-origin: center center !important;
                                        width: 100vh !important;
                                        height: 100vw !important;
                                        position: fixed !important;
                                        top: 50% !important;
                                        left: 50% !important;
                                        margin-left: -50vh !important;
                                        margin-top: -50vw !important;
                                    `;
                                }

                                // 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è Android - –ø–æ–ø—Ä–æ–±—É–µ–º webkit
                                if (navigator.userAgent.includes('Android')) {
                                    console.log('Android detected, applying additional styles');
                                    document.body.style.overflow = 'hidden';
                                    document.documentElement.style.overflow = 'hidden';
                                }

                            } catch (error) {
                                console.log('Failed to lock orientation:', error);
                            }
                        } else {
                            // –í—ã—Ö–æ–¥–∏–º –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
                            console.log('Exiting fullscreen mode');
                            window.oldFrameStyles ? frames[i].style.cssText = window.oldFrameStyles : frames[i].style.cssText = '';

                            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
                            try {
                                console.log('Unlocking orientation...');

                                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Telegram API
                                if (window.Telegram?.WebApp) {
                                    if (window.Telegram.WebApp.toggleOrientationLock) {
                                        console.log('Unlocking via Telegram API');
                                        window.Telegram.WebApp.toggleOrientationLock(false);
                                    }

                                    // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                                    try {
                                        if (window.TelegramWebviewProxy?.postEvent) {
                                            window.TelegramWebviewProxy.postEvent('web_app_toggle_orientation_lock', JSON.stringify({locked: false}));
                                        } else if (window.parent) {
                                            const data = JSON.stringify({
                                                eventType: 'web_app_toggle_orientation_lock',
                                                eventData: { locked: false }
                                            });
                                            window.parent.postMessage(data, 'https://web.telegram.org');
                                        }
                                    } catch (e) {
                                        console.log('Telegram unlock fallback failed:', e);
                                    }
                                }

                                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                                if (screen.orientation && screen.orientation.unlock) {
                                    console.log('Unlocking via screen.orientation');
                                    screen.orientation.unlock();
                                }

                                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è Android
                                if (navigator.userAgent.includes('Android')) {
                                    document.body.style.overflow = '';
                                    document.documentElement.style.overflow = '';
                                }

                            } catch (error) {
                                console.log('Failed to unlock orientation:', error);
                            }
                        }
                        break;
                    }
                }
            }
        };
    </script>
    <script src="module.js"></script>
</body>
</html>
